<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de M√≠dias - Sistema de M√≠dias</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-logo">üé¨ Sistema de M√≠dias</h1>
            <div class="nav-links">
                <a href="/dashboard">Dashboard</a>
                <a href="/medias" class="active">M√≠dias</a>
                <a href="/medias/new">Nova M√≠dia</a>
                <button id="logout-btn" class="btn-logout">Sair</button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="media-list-container">
            <div class="page-header">
                <h1>üìã Todas as M√≠dias</h1>
                <p>Gerencie sua cole√ß√£o completa</p>
            </div>

            <div class="actions-bar">
                <a href="/medias/new" class="btn btn-primary">
                    ‚ûï Nova M√≠dia
                </a>
                <div class="filters">
                    <select id="filter-type" class="filter-select">
                        <option value="">Todos os Tipos</option>
                        <option value="Lucas">Lucas</option>
                        <option value="DVD">DVD</option>
                        <option value="CD4">CD4</option>
                        <option value="Audio">Audio</option>
                    </select>
                    <button id="clear-filters" class="btn btn-outline">
                        üîÑ Limpar Filtros
                    </button>
                </div>
            </div>

            <div class="media-table-container">
                <table class="media-table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>T√≠tulo</th>
                            <th>Data</th>
                            <th>Adobe</th>
                            <th>Usu√°rio</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="media-table-body">
                        <tr>
                            <td colspan="6" class="loading">Carregando m√≠dias...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination">
                <button id="prev-page" class="btn btn-outline" disabled>‚Üê Anterior</button>
                <span id="page-info">P√°gina 1</span>
                <button id="next-page" class="btn btn-outline" disabled>Pr√≥xima ‚Üí</button>
            </div>
        </div>
    </main>

    <script src="/js/api.js"></script>
    <script>
        class MediaList {
            constructor() {
                this.medias = [];
                this.filteredMedias = [];
                this.currentPage = 1;
                this.itemsPerPage = 10;
                this.currentFilter = '';
                
                this.checkAuth();
                this.loadMedias();
                this.setupEventListeners();
            }

            checkAuth() {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
            }

            async loadMedias() {
                try {
                    this.medias = await MediaAPI.getMedias();
                    this.applyFilters();
                    this.renderTable();
                    
                } catch (error) {
                    console.error('Erro ao carregar m√≠dias:', error);
                    document.getElementById('media-table-body').innerHTML = `
                        <tr>
                            <td colspan="6" class="error">Erro ao carregar m√≠dias</td>
                        </tr>
                    `;
                }
            }

            applyFilters() {
                const filterType = document.getElementById('filter-type').value;
                
                this.filteredMedias = this.medias.filter(media => {
                    if (filterType && media.tipo !== filterType) {
                        return false;
                    }
                    return true;
                });
                
                this.currentPage = 1;
                this.updatePagination();
            }

            renderTable() {
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const pageMedias = this.filteredMedias.slice(startIndex, endIndex);
                
                const tbody = document.getElementById('media-table-body');
                
                if (pageMedias.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty">Nenhuma m√≠dia encontrada</td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = pageMedias.map(media => `
                    <tr>
                        <td>
                            <span class="media-type-badge ${media.tipo.toLowerCase()}">
                                ${this.getTypeIcon(media.tipo)} ${media.tipo}
                            </span>
                        </td>
                        <td>${media.titulo}</td>
                        <td>${new Date(media.data).toLocaleDateString('pt-BR')}</td>
                        <td>${media.adobe || '-'}</td>
                        <td>${media.usuario?.name || 'N/A'}</td>
                        <td>
                            <button onclick="mediaList.editMedia('${media._id}')" class="btn btn-small">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="mediaList.deleteMedia('${media._id}')" class="btn btn-small btn-danger">
                                üóëÔ∏è Excluir
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            getTypeIcon(tipo) {
                const icons = {
                    'Lucas': 'üé¨',
                    'DVD': 'üé•',
                    'CD4': 'üíø',
                    'Audio': 'üéµ'
                };
                return icons[tipo] || 'üìÄ';
            }

            updatePagination() {
                const totalPages = Math.ceil(this.filteredMedias.length / this.itemsPerPage);
                const pageInfo = document.getElementById('page-info');
                const prevBtn = document.getElementById('prev-page');
                const nextBtn = document.getElementById('next-page');
                
                pageInfo.textContent = `P√°gina ${this.currentPage} de ${totalPages}`;
                prevBtn.disabled = this.currentPage === 1;
                nextBtn.disabled = this.currentPage === totalPages || totalPages === 0;
            }

            editMedia(id) {
                alert(`Editar m√≠dia: ${id}\n\nEsta funcionalidade ser√° implementada em breve!`);
                // window.location.href = `/medias/edit/${id}`;
            }

            async deleteMedia(id) {
                if (!confirm('Tem certeza que deseja excluir esta m√≠dia?')) {
                    return;
                }
                
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Voc√™ precisa estar logado para excluir m√≠dias');
                        return;
                    }
                    
                    await MediaAPI.deleteMedia(id);
                    alert('M√≠dia exclu√≠da com sucesso!');
                    this.loadMedias(); // Recarregar a lista
                    
                } catch (error) {
                    alert('Erro ao excluir m√≠dia: ' + error.message);
                }
            }

            setupEventListeners() {
                // Filtros
                document.getElementById('filter-type').addEventListener('change', () => {
                    this.applyFilters();
                    this.renderTable();
                });
                
                document.getElementById('clear-filters').addEventListener('click', () => {
                    document.getElementById('filter-type').value = '';
                    this.applyFilters();
                    this.renderTable();
                });
                
                // Pagina√ß√£o
                document.getElementById('prev-page').addEventListener('click', () => {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                        this.renderTable();
                        this.updatePagination();
                    }
                });
                
                document.getElementById('next-page').addEventListener('click', () => {
                    const totalPages = Math.ceil(this.filteredMedias.length / this.itemsPerPage);
                    if (this.currentPage < totalPages) {
                        this.currentPage++;
                        this.renderTable();
                        this.updatePagination();
                    }
                });
                
                // Logout
                document.getElementById('logout-btn').addEventListener('click', () => {
                    localStorage.removeItem('token');
                    window.location.href = '/';
                });
            }
        }

        // Inicializar lista de m√≠dias
        let mediaList;
        document.addEventListener('DOMContentLoaded', () => {
            mediaList = new MediaList();
        });
    </script>
</body>
</html>